{{- $nodeSelector := ternary (list
    (dict
      "Name" "powerpi-storage"
      "Value" "true"
    )
  ) (list) .Values.global.useCluster 
}}

{{- $data := dict
  "Name" "database-backup-job"
  "Image" "postgres"
  "RequestMemory" "50Mi"
  "NodeSelector" $nodeSelector
  "Schedule" "5 23 * * *"
  "Command" (list "pg_dump")
  "Args" (list 
    "--host=database"
    "--file=$(BACKUP_FILE)"
    "--data-only"
    "--compress=9"
  )
  "PersistentVolumeClaim" (dict
    "Name" "database-backup-data"
    "Claim" "database-backup-volume-claim"
    "Path" "/srv/backup"
  )
  "Env" (list
    (dict
      "Name" "BACKUP_FILE"
      "Value" "/srv/backup/$(date +%Y-%m-%d)-powerpi.sql"
    )
  )
  "Secret" (list
    (dict
      "Name" "database-secret"
      "Env" (list
        (dict
          "Name" "PGDATABASE"
          "Key" "schema"
        )
        (dict
          "Name" "PGUSER"
          "Key" "username"
        )
        (dict
          "Name" "PGPASSWORD"
          "Key" "password"
        )
      )
    )
  )
}}

{{- include "powerpi.job" (merge (dict "Params" $data) . ) }}
